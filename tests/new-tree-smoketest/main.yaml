---
# vim: set ft=ansible:
#
# A playbook that performs a simple smoke test of Atomic Host upgrading to
# a new ostree.
#
# This basically just does an upgrade, reboot, rollback, and reboot on an
# Atomic Host.
#
# If the 'jenkins' tag is not skipped, it also performs some data gathering
# operations which will generate output files on the host that can be
# retrieved.
#
# This playbook expects the following variables defined:
#  - datadir
#  - initial_rpms
#  - upgraded_rpms
#
# Additional variables may be required by the included task files.
#
# Most variables are defined in the included file 'vars/smoketest_vars.yaml'
#
- name: Atomic Host new tree smoketest
  hosts: all
  sudo: yes

  vars_files:
    - ../../vars/smoketest_vars.yaml
    - ../../vars/subscription.yaml

  vars:
    - upgraded_rpms: "upgraded_rpm_list.txt"

  tasks:
    - name: Check if system is an Atomic Host
      include: ../../common/atomic.yaml

    - name: Register using subscription-manager
      include: ../../rhel/subscribe.yaml
      when: ansible_distribution == "RedHat"

    - name: Setup data directory
      include: ../../common/data_dir.yaml

    - name: Copy downgrade check script
      copy:
        dest: "{{ datadir }}/check_downgrade.py"
        mode: 0744
        src: ../../common/scripts/check_downgrade.py

    - name: Gather initial RPM list
      include: ../../common/rpm_list.yaml rpm_file="{{ initial_rpms }}"
      tags:
        - jenkins

    - name: Get initial atomic version
      shell: atomic host status | awk '/^*/{print $4}'
      register: initial_atomic_version
      tags:
        - jenkins

    - name: Upgrade to latest tree
      shell: atomic host upgrade | tee atomic_host_upgrade
      args:
        chdir: "{{ datadir }}"

    - name: Run downgrade check script
      command: "{{ datadir }}/check_downgrade.py {{ datadir }}/atomic_host_upgrade"

    - name: Reboot the host
      include: ../../common/ans_reboot.yaml

    - name: Check /tmp (BZ 1276775)
      include: ../../common/check_tmp_perms.yaml

    - name: Gather upgraded RPM list
      include: ../../common/rpm_list.yaml rpm_file="{{ upgraded_rpms }}"
      tags:
        - jenkins

    - name: Get upgraded atomic version
      shell: atomic host status | awk '/^*/{print $4}'
      register: upgraded_atomic_version
      tags:
        - jenkins

    - name: Gather data about system
      include: ../../common/collect_data.yaml
      tags:
        - jenkins

    - name: Generate output files
      include: ../../common/output_files.yaml
      tags:
        - jenkins

    - name: Rollback to previous deployment
      shell: atomic host rollback

    - name: Reboot into previous deployment
      include: ../../common/ans_reboot.yaml

    - name: Remove all registrations using subscription-manager
      include: ../../rhel/unsubscribe.yaml
      when: ansible_distribution == "RedHat"
